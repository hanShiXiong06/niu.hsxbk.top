<template>
    <div class="main-container w-full p-5 bg-white" v-loading="loading">
        <div class="flex justify-between items-center h-[32px] mb-4">
            <span class="text-[20px]">{{ t('localAppText') }}</span>
        </div>
        <div class="relative">
            <!-- <div class="absolute right-0 top-[2px] flex items-center cursor-pointer z-[4] border border-inherit">
                <div class="flex item-center justify-center px-[6px] py-[4px]"
                    :class="{ 'bg-slate-200': showType == 'small' }" @click="showType = 'small'">
                    <img src="@/app/assets/images/app_store/switch_icon_1.png" class=" w-[16px] h-[16px]">
                </div>
                <div class="flex item-center justify-center px-[6px] py-[4px]"
                    :class="{ 'bg-slate-200': showType == 'large' }" @click="showType = 'large'">
                    <img src="@/app/assets/images/app_store/switch_icon_2.png" class="w-[16px] h-[16px] ">
                </div>
            </div> -->

            <el-tabs v-model="activeName" class="demo-tabs" @tab-click="handleClick">
                <el-tab-pane :label="installLabel" name="installed">
                    <div class="flex flex-wrap px-2 plug-list pb-10">
                        <div v-for="(item, index) in localList.installed" :key="index + 'a'"
                            class="flex items-center cursor-pointer  w-[295px] relative plug-item mr-4 mb-4"
                            @click="getAddonDetialFn(item)" v-if="showType == 'small'">
                            <div class="p-3">
                                <img class="w-[44px] h-[44px] rounded-sm" v-if="item.icon" :src="item.icon" alt="">
                                <img class="w-[44px] h-[44px] rounded-sm" v-else src="@/app/assets/images/icon-addon.png"
                                    alt="">
                            </div>
                            <div class="flex items-center w-[220px] border-b py-3 justify-between">
                                <div class="flex flex-col">
                                    <span class="text-[14px] truncate w-[160px]">{{ item.title }}</span>
                                    <span class="text-xs text-gray-400 truncate w-[160px] mt-[4px]">{{ item.desc }}</span>
                                </div>
                                <el-button size="small" round class="!text-primary !border-primary !bg-transparent"
                                    @click.stop="uninstallAddonFn(item.key)">{{ t('unload')
                                    }}</el-button>
                            </div>
                        </div>

                        <div class="flex flex-wrap plug-list pb-10 plug-large" v-if="showType == 'large'">
                            <div class="app-item cursor-pointer mr-4 mt-[20px] pb-2 bg-[#f7f7f7]"
                                v-for="(item, index) in localList.installed" :key="index + 'a'"
                                @click="getAddonDetialFn(item)">
                                <div class="flex justify-center items-center">
                                    <img class="w-[240px] h-[120px]" v-if="item.cover" :src="item.cover" />
                                    <img v-else class="w-[240px] h-[120px]"
                                        src="@/app/assets/images/app_store/app_store_default.png" />
                                </div>
                                <div class="flex w-[240px] h-[46px]">
                                    <div class="text-left mt-2 w-[190px]">
                                        <p class="app-text text-[14px] text-[#222] pl-2">{{ item.title }}</p>
                                        <p class="app-text text-[12px] text-[#999] pl-2">{{ item.desc }}</p>
                                    </div>
                                    <div class="flex items-center pr-2">
                                        <el-button size="small" round class="!text-primary !border-primary !bg-transparent"
                                            @click.stop="uninstallAddonFn(item.key)">{{ t('unload')
                                            }}</el-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <el-empty class="mx-auto overview-empty" v-if="!localList.installed.length && !loading">
                            <template #image>
                                <div class="w-[230px] mx-auto">
                                    <img src="@/app/assets/images/index/apply_empty.png" class="max-w-full" alt="">
                                </div>
                            </template>
                            <template #description>
                                <p class="flex items-center">{{ t('installed-empty') }}</p>
                            </template>
                        </el-empty>
                    </div>
                </el-tab-pane>
                <el-tab-pane :label="uninstalledLabel" name="uninstalled">
                    <div class="flex flex-wrap px-2 plug-list pb-10">

                        <div v-for="(item, index) in localList.uninstalled" :key="index + 'a'"
                            class="flex items-center cursor-pointer  w-[295px] relative plug-item mr-4 mb-4"
                            @click="getAddonDetialFn(item)" v-if="showType == 'small'">
                            <div class="p-3">
                                <img v-if="item.icon" class="w-[44px] h-[44px] rounded-sm" :src="item.icon" alt="">
                                <img v-else class="w-[44px] h-[44px] rounded-sm" src="@/app/assets/images/icon-addon.png"
                                    alt="">
                            </div>
                            <div class="flex items-center w-[220px] border-b py-3 justify-between">
                                <div class="flex flex-col">
                                    <span class="text-[14px] truncate w-[160px]">{{ item.title }}</span>
                                    <span class="text-xs text-gray-400 truncate w-[160px] mt-[4px]">{{ item.desc }}</span>
                                </div>
                                <el-button v-if="item.is_download" size="small" round
                                    class="!text-primary !border-primary !bg-transparent"
                                    @click.stop="installAddonFn(item.key)">{{ t('install')
                                    }}</el-button>
                                <el-button v-else size="small" :loading="downloading == item.key"
                                    :disabled="downloading != ''" round
                                    class="!text-primary !border-primary !bg-transparent" @click.stop="downEvent(item)">{{
                                        t('down') }}</el-button>
                            </div>
                        </div>

                        <div class="flex flex-wrap plug-list pb-10 plug-large" v-if="showType == 'large'">
                            <div class="app-item cursor-pointer mr-4 mt-[20px] pb-2 bg-[#f7f7f7]"
                                v-for="(item, index) in localList.uninstalled" :key="index + 'a'"
                                @click="getAddonDetialFn(item)">
                                <div class="flex justify-center items-center">
                                    <img v-if="item.cover && !item.is_download" class="w-[240px] h-[120px]"
                                        :src="img(item.cover)" />
                                    <img v-else-if="item.cover && item.is_download" class="w-[240px] h-[120px]"
                                        :src="item.cover" />
                                    <img v-else class="w-[240px] h-[120px]"
                                        src="@/app/assets/images/app_store/app_store_default.png" />
                                </div>
                                <div class="flex w-[240px] h-[46px]">
                                    <div class="text-left mt-2 w-[190px]">
                                        <p class="app-text text-[14px] text-[#222] pl-2">{{ item.title }}</p>
                                        <p class="app-text text-[12px] text-[#999] pl-2">{{ item.desc }}</p>
                                    </div>
                                    <div class="flex items-center pr-2">
                                        <el-button v-if="item.is_download" size="small" round
                                            class="!text-primary !border-primary !bg-transparent"
                                            @click.stop="installAddonFn(item.key)">{{ t('install')
                                            }}</el-button>
                                        <el-button v-else size="small" :loading="downloading == item.key"
                                            :disabled="downloading != ''" round
                                            class="!text-primary !border-primary !bg-transparent"
                                            @click.stop="downEvent(item)">{{ t('down') }}</el-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <el-empty class="mx-auto overview-empty" v-if="!localList.uninstalled.length && !loading">
                            <template #image>
                                <div class="w-[230px] mx-auto">
                                    <img src="@/app/assets/images/index/apply_empty.png" class="max-w-full" alt="">
                                </div>
                            </template>
                            <template #description>
                                <p class="flex items-center">
                                    <span>{{ t('descriptionLeft') }}</span>
                                    <el-link type="primary" @click="goRouter" class="mx-[5px]">{{ t('link') }}</el-link>
                                    <span>{{ t('descriptionRight') }}</span>
                                </p>
                            </template>
                        </el-empty>
                    </div>
                </el-tab-pane>
                <el-tab-pane :label="allLabel" name="buy">

                    <div class="flex flex-wrap px-2 plug-list pb-10">

                        <template v-if="authinfo">
                            <div v-for="(item, index) in localList.all" :key="index + 'a'"
                                class="flex items-center cursor-pointer  w-[295px] relative plug-item mr-4 mb-4"
                                @click="getAddonDetialFn(item)" v-if="showType == 'small'">
                                <div class="p-3">
                                    <img v-if="item.icon" class="w-[44px] h-[44px] rounded-sm" :src="item.icon" alt="">
                                    <img v-else class="w-[44px] h-[44px] rounded-sm"
                                        src="@/app/assets/images/icon-addon.png" alt="">
                                </div>
                                <div class="flex items-center w-[220px] border-b py-3 justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-[14px] truncate w-[160px]">{{ item.title }}</span>
                                        <span class="text-xs text-gray-400 truncate w-[160px] mt-[4px]">{{ item.desc
                                        }}</span>
                                    </div>
                                    <el-button v-if="item.install_info && Object.keys(item.install_info)?.length"
                                        size="small" round class="!text-primary !border-primary !bg-transparent"
                                        @click.stop="uninstallAddonFn(item.key)">{{ t('unload')
                                        }}</el-button>
                                    <el-button v-else-if="item.is_download && item.install_info <= 0" size="small" round
                                        class="!text-primary !border-primary !bg-transparent"
                                        @click.stop="installAddonFn(item.key)">{{ t('install')
                                        }}</el-button>
                                    <el-button v-else size="small" :loading="downloading == item.key"
                                        :disabled="downloading != ''" round
                                        class="!text-primary !border-primary !bg-transparent"
                                        @click.stop="downEvent(item)">{{
                                            t('down') }}</el-button>
                                </div>
                            </div>

                            <div class="flex flex-wrap plug-list pb-10 plug-large" v-if="showType == 'large'">
                                <div class="app-item cursor-pointer mr-4 mt-[20px] pb-2 bg-[#f7f7f7]"
                                    v-for="(item, index) in localList.all" :key="index + 'a'"
                                    @click="getAddonDetialFn(item)">
                                    <div class="flex justify-center items-center">
                                        <img v-if="item.icon && !item.is_download" class="w-[240px] h-[120px]"
                                            :src="img(item.icon)" />
                                        <img v-else-if="item.icon && item.is_download" class="w-[240px] h-[120px]"
                                            :src="item.icon" />
                                        <img v-else class="w-[240px] h-[120px]"
                                            src="@/app/assets/images/app_store/app_store_default.png" />
                                    </div>
                                    <div class="flex w-[240px] h-[46px]">
                                        <div class="text-left mt-2 w-[190px]">
                                            <p class="app-text text-[14px] text-[#222] pl-2">{{ item.title }}</p>
                                            <p class="app-text text-[12px] text-[#999] pl-2">{{ item.desc }}</p>
                                        </div>
                                        <div class="flex items-center pr-2">
                                            <el-button v-if="item.install_info && Object.keys(item.install_info)?.length"
                                                size="small" round class="!text-primary !border-primary !bg-transparent"
                                                @click.stop="uninstallAddonFn(item.key)">{{ t('unload')
                                                }}</el-button>
                                            <el-button v-else-if="item.is_download && item.install_info <= 0" size="small"
                                                round class="!text-primary !border-primary !bg-transparent"
                                                @click.stop="installAddonFn(item.key)">{{ t('install')
                                                }}</el-button>
                                            <el-button v-else size="small" round :loading="downloading == item.key"
                                                :disabled="downloading != ''"
                                                class="!text-primary !border-primary !bg-transparent"
                                                @click.stop="downEvent(item)">{{ t('down') }}</el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div v-if="!localList.all.length && !loading && !authinfo"
                            class="mx-auto overview-empty flex flex-col items-center pt-14 pb-6">
                            <div class="mb-[20px] text-sm text-[#888]">检测到当前账号尚未绑定授权，请先绑定授权！</div>
                            <div class="flex flex-1  flex-wrap justify-center relative">
                                <el-button class="w-[154px] !h-[48px] mt-[8px]" type="primary"
                                    @click="authCodeApproveFn">授权码认证</el-button>
                                <el-popover ref="getAuthCodeDialog" placement="bottom" :width="478" trigger="click"
                                    class="mt-[8px]">
                                    <div class="px-[18px] py-[8px]">
                                        <p class="leading-[32px] text-[14px]">
                                            您在官方应用市场购买任意一款应用，即可获得授权码。输入正确授权码认证通过后，即可支持在线升级和其它相关服务</p>
                                        <div class="flex justify-end mt-[36px]">
                                            <el-button class="w-[182px] !h-[48px]" plain @click="market">去应用市场逛逛</el-button>
                                            <el-button class="w-[100px] !h-[48px]" plain
                                                @click="getAuthCodeDialog.hide()">关闭</el-button>
                                        </div>
                                    </div>
                                    <template #reference>
                                        <el-button
                                            class="w-[154px] !h-[48px] mt-[8px] !text-[var(--el-color-primary)] hover:!text-[var(--el-color-primary)] !bg-transparent"
                                            plain type="primary">如何获取授权码?</el-button>
                                    </template>
                                </el-popover>
                            </div>
                        </div>
                        <el-dialog v-model="authCodeApproveDialog" title="授权码认证" width="400px">
                            <el-form :model="formData" label-width="0" ref="formRef" :rules="formRules" class="page-form">
                                <el-card class="box-card !border-none" shadow="never">
                                    <el-form-item prop="auth_code">
                                        <el-input v-model="formData.auth_code" :placeholder="t('authCodePlaceholder')"
                                            class="input-width" clearable size="large" />
                                    </el-form-item>

                                    <div class="mt-[20px]">
                                        <el-form-item prop="auth_secret">
                                            <el-input v-model="formData.auth_secret" clearable
                                                :placeholder="t('authSecretPlaceholder')" class="input-width"
                                                size="large" />
                                        </el-form-item>
                                    </div>

                                    <div class="text-sm mt-[10px] text-info">{{ t('authInfoTips') }}</div>

                                    <div class="mt-[20px]">
                                        <el-button type="primary" class="w-full" size="large" :loading="saveLoading"
                                            @click="save(formRef)">{{ t('confirm') }}</el-button>
                                    </div>
                                    <div class="mt-[10px] text-right">
                                        <el-button type="primary" link @click="market">{{ t('notHaveAuth') }}</el-button>
                                    </div>
                                </el-card>
                            </el-form>
                        </el-dialog>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>

        <!-- 详情 -->
        <el-dialog v-model="appStoreShowDialog" :title="t('plugDetail')" width="500px" :destroy-on-close="true">
            <el-form :model="appStoreInfo" label-width="120px" ref="formRef" class="page-form">
                <el-form-item :label="t('title')">
                    <div class="input-width"> {{ appStoreInfo.title }} </div>
                </el-form-item>
                <el-form-item :label="t('desc')">
                    <div class="input-width"> {{ appStoreInfo.desc }} </div>
                </el-form-item>
                <el-form-item :label="t('author')">
                    <div class="input-width"> {{ appStoreInfo.author }} </div>
                </el-form-item>
                <el-form-item :label="t('version')">
                    <div class="input-width"> {{ appStoreInfo.version }} </div>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button type="primary" @click="appStoreShowDialog = false">{{ t('confirm') }}</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- 安装弹窗 -->
        <el-dialog v-model="installShowDialog" :title="t('addonInstall')" width="850px" :close-on-click-modal="false"
            :close-on-press-escape="false" :before-close="installShowDialogClose">
            <el-steps :space="200" :active="installStep" finish-status="success" align-center>
                <el-step :title="t('envCheck')" class="flex-1" />
                <el-step :title="t('installProgress')" class="flex-1" />
                <el-step :title="t('installComplete')" class="flex-1" />
            </el-steps>
            <div v-show="installStep == 1" v-loading="!installCheckResult.dir">
                <el-scrollbar max-height="50vh">
                    <div class="min-h-[150px]">
                        <div class="bg-[#fff] my-3" v-if="installCheckResult.dir">
                            <p class="pt-[20px] pl-[20px] ">{{ t('dirPermission') }}</p>
                            <div class="px-[20px] pt-[10px] text-[14px]">
                                <el-row class="py-[10px] items table-head-bg pl-[15px] mb-[10px]">
                                    <el-col :span="12">
                                        <span>{{ t('path') }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span>{{ t('demand') }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span>{{ t('status') }}</span>
                                    </el-col>
                                </el-row>
                                <el-row class="pb-[10px] items pl-[15px]"
                                    v-for="item in installCheckResult.dir.is_readable">
                                    <el-col :span="12">
                                        <span>{{ item.dir }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span>{{ t('readable') }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span v-if="item.status"><el-icon color="green"><Select /></el-icon></span>
                                        <span v-else>
                                            <el-icon color="red">
                                                <CloseBold />
                                            </el-icon>
                                        </span>
                                    </el-col>
                                </el-row>
                                <el-row class="pb-[10px] items pl-[15px]" v-for="item in installCheckResult.dir.is_write">
                                    <el-col :span="12">
                                        <span>{{ item.dir }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span>{{ t('write') }}</span>
                                    </el-col>
                                    <el-col :span="6">
                                        <span v-if="item.status"><el-icon color="green"><Select /></el-icon></span>
                                        <span v-else>
                                            <el-icon color="red">
                                                <CloseBold />
                                            </el-icon>
                                        </span>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>
                    </div>
                </el-scrollbar>
                <div class="flex justify-end">
                    <el-tooltip effect="dark" :content="t('installTips')" placement="top">
                        <el-button type="default" :disabled="!installCheckResult.is_pass || cloudInstalling"
                            :loading="localInstalling" @click="handleInstall">{{
                                t('localInstall')
                            }}</el-button>
                    </el-tooltip>
                    <el-tooltip effect="dark" :content="t('cloudInstallTips')" placement="top">
                        <el-button type="primary" :disabled="!installCheckResult.is_pass || localInstalling"
                            :loading="cloudInstalling" @click="handleCloudInstall">{{
                                t('cloudInstall')
                            }}</el-button>
                    </el-tooltip>
                </div>
            </div>
            <div v-show="installStep == 2" class="h-[50vh] mt-[20px]">
                <terminal name="my-terminal" :context="currAddon" :init-log="null" :show-header="false"
                    :show-log-time="true" />
            </div>
            <div v-show="installStep == 3" class="h-[50vh] mt-[20px] flex flex-col">
                <el-result icon="success" :title="t('addonInstallSuccess')"></el-result>
                <!-- 提示信息 -->
                <div v-for="item in installAfterTips" class="mb-[10px]">
                    <el-alert :title="item" type="error" :closable="false" />
                </div>
            </div>
        </el-dialog>

        <el-dialog v-model="uninstallShowDialog" :title="t('addonUninstall')" width="850px" :close-on-click-modal="false"
            :close-on-press-escape="false">
            <el-scrollbar max-height="50vh">
                <div class="min-h-[150px]">
                    <div class="bg-[#fff] my-3" v-if="uninstallCheckResult.dir">
                        <p class="pt-[20px] pl-[20px] ">{{ t('dirPermission') }}</p>
                        <div class="px-[20px] pt-[10px] text-[14px]">
                            <el-row class="py-[10px] items table-head-bg pl-[15px] mb-[10px]">
                                <el-col :span="12">
                                    <span>{{ t('path') }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span>{{ t('demand') }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span>{{ t('status') }}</span>
                                </el-col>
                            </el-row>
                            <el-row class="pb-[10px] items pl-[15px]" v-for="item in uninstallCheckResult.dir.is_readable">
                                <el-col :span="12">
                                    <span>{{ item.dir }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span>{{ t('readable') }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span v-if="item.status"><el-icon color="green"><Select /></el-icon></span>
                                    <span v-else>
                                        <el-icon color="red">
                                            <CloseBold />
                                        </el-icon>
                                    </span>
                                </el-col>
                            </el-row>
                            <el-row class="pb-[10px] items pl-[15px]" v-for="item in uninstallCheckResult.dir.is_write">
                                <el-col :span="12">
                                    <span>{{ item.dir }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span>{{ t('write') }}</span>
                                </el-col>
                                <el-col :span="6">
                                    <span v-if="item.status"><el-icon color="green"><Select /></el-icon></span>
                                    <span v-else>
                                        <el-icon color="red">
                                            <CloseBold />
                                        </el-icon>
                                    </span>
                                </el-col>
                            </el-row>
                        </div>
                    </div>
                </div>
            </el-scrollbar>
        </el-dialog>
    </div>
</template>

<script lang="ts" setup>
import { ref, reactive, watch, computed, h } from 'vue'
import { t } from '@/lang'
import { getAddonLocal, uninstallAddon, installAddon, preInstallCheck, cloudInstallAddon, getAddonInstalltask, getAddonCloudInstallLog, preUninstallCheck } from '@/app/api/addon'
import { downloadVersion, getAuthinfo, setAuthinfo } from '@/app/api/module'
import { TabsPaneContext, ElMessageBox, ElNotification, FormInstance, FormRules } from 'element-plus'
import { img } from '@/utils/common'
import { Terminal, api as terminalApi } from 'vue-web-terminal'
import { useRouter } from 'vue-router'
import useUserStore from '@/stores/modules/user'
import storage from '@/utils/storage'

const router = useRouter()
const activeName = ref('installed')
const loading = ref<Boolean>(false)
const showType = ref('small')
const downloading = ref('')
const installAfterTips = ref<string[]>([])
const userStore = useUserStore()

const downEvent = (param: Record<string, any>) => {
    if (downloading.value) return
    downloading.value = param.key

    downloadVersion({ addon: param.key, version: param.version }).then(() => {
        installAddonFn(param.key)
        localListFn()
        downloading.value = ''
    }).catch(() => {
        downloading.value = ''
    })
}

const installLabel = computed(() => {
    let text = t('installLabel')
    localList.value.installed.length && (text += ` (${localList.value.installed.length})`)
    return text
})

const uninstalledLabel = computed(() => {
    let text = t('uninstalledLabel')
    localList.value.uninstalled.length && (text += ` (${localList.value.uninstalled.length})`)
    return text
})

const allLabel = computed(() => {
    let text = t('buyLabel')
    localList.value.all.length && (text += ` (${localList.value.all.length})`)
    return text
})

const authCode = ref('')
getAuthinfo().then(res => {
    if (res.data.data && res.data.data.auth_code) {
        authCode.value = res.data.data.auth_code
    }
}).catch(() => {
})

/**
 * 本地下载的插件列表
 */
const localList = ref({
    installed: [],
    uninstalled: [],
    all: [],
    error: ''
})

const localListFn = () => {
    loading.value = true
    getAddonLocal({}).then(res => {
        const data = res.data.list
        localList.value.error = res.data.error
        localList.value.installed = []
        localList.value.uninstalled = []
        localList.value.all = []
        for (const i in data) {
            if (data[i].is_local == false) localList.value.all.push(data[i])

            if (data[i].install_info && Object.keys(data[i].install_info)?.length) {
                localList.value.installed.push(data[i])
            } else {
                if (data[i].is_download == true) localList.value.uninstalled.push(data[i])
            }
        }

        loading.value = false
    }).catch(() => {
        loading.value = false
    })
}

localListFn()

const handleClick = (tab: TabsPaneContext, event: Event) => {
    // if (tab.paneName == 'buy' && localList.value.error != '') {
    //     ElMessage({
    //         message: localList.value.error,
    //         grouping: true,
    //         type: 'error'
    //     })
    // }
}

const currAddon = ref('')

// 安装面板弹窗
const installShowDialog = ref(false)

// 安装步骤
const installStep = ref(1)

// 安装检测结果
const installCheckResult = ref({})

/**
 * 安装
 * @param key
 */
const installAddonFn = (key: string) => {
    currAddon.value = key
    installStep.value = 1
    installShowDialog.value = true
    installAfterTips.value = []

    preInstallCheck(key).then(res => {
        installCheckResult.value = res.data
        userStore.clearRouters()
    }).catch(() => { })
}

/**
 * 获取正在进行的安装任务
 */
let notificationEl = null
const getInstallTask = (first: boolean = true) => {
    getAddonInstalltask().then(res => {
        if (res.data) {
            if (first) {
                installLog = []
                currAddon.value = res.data.addon
                if (!installShowDialog.value) {
                    notificationEl = ElNotification.success({
                        title: t('warning'),
                        dangerouslyUseHTMLString: true,
                        message: h('div', {}, [
                            t('installingTips'),
                            h('span', { class: 'text-primary cursor-pointer', onClick: checkInstallTask }, [t('installPercent')])
                        ]),
                        duration: 0,
                        showClose: false
                    })
                }
            }
            if (res.data.error) {
                return
            }
            if (res.data.mode == 'cloud') {
                getCloudInstallLog()
            }
            setTimeout(() => {
                getInstallTask(false)
            }, 2000)
        } else {
            if (!first) {
                installStep.value = 3
                userStore.clearRouters()
                localListFn()
                userStore.getAppList()
                notificationEl.close()
            }
        }
    })
}

getInstallTask()

const checkInstallTask = () => {
    installShowDialog.value = true
    installStep.value = 2
}

const localInstalling = ref(false)
/**
 * 安装插件
 */
const handleInstall = () => {
    if (!installCheckResult.value.is_pass || localInstalling.value) return
    localInstalling.value = true

    installAddon({ addon: currAddon.value }).then(res => {
        installStep.value = 3
        localListFn()
        userStore.getAppList()
        localInstalling.value = false
        if (res.data.length) installAfterTips.value = res.data
    }).catch((res) => {
        localInstalling.value = false
    })
}

const cloudInstalling = ref(false)

/**
 * 云安装插件
 */
const handleCloudInstall = () => {
    if (!authCode.value) {
        authElMessageBox()
        return
    }

    if (!installCheckResult.value.is_pass || cloudInstalling.value) return
    cloudInstalling.value = true

    cloudInstallAddon({ addon: currAddon.value }).then(res => {
        installStep.value = 2
        terminalApi.execute('my-terminal', 'clear')
        terminalApi.pushMessage('my-terminal', { content: '开始安装插件', class: 'info' })
        getInstallTask()
        cloudInstalling.value = false
    }).catch((res) => {
        cloudInstalling.value = false
    })
}

const authElMessageBox = () => {
    ElMessageBox.confirm(
        t('authTips'),
        t('warning'),
        {
            distinguishCancelAndClose: true,
            confirmButtonText: t('toBind'),
            cancelButtonText: t('toNiucloud')
        }
    ).then(() => {
        router.push({ path: '/app/authorize' })
    }).catch((action: string) => {
        if (action === 'cancel') {
            window.open('https://www.niucloud.com/product')
        }
    })
}

let installLog: string[] = []
const getCloudInstallLog = () => {
    getAddonCloudInstallLog(currAddon.value)
        .then(res => {
            const data = res.data.data ?? []
            if (data[0] && data[0].length && installShowDialog.value == true) {
                data[0].forEach(item => {
                    if (!installLog.includes(item.action)) {
                        terminalApi.pushMessage('my-terminal', { content: `正在执行：${item.action}` })
                        installLog.push(item.action)

                        if (item.code == 0) {
                            terminalApi.pushMessage('my-terminal', { content: item.msg, class: 'error' })
                        }
                    }
                })
            }
        })
        .catch(() => {
            notificationEl?.close()
        })
}

watch(currAddon, (nval) => {
    installCheckResult.value = {}
})

// 卸载面板弹窗
const uninstallShowDialog = ref(false)

// 卸载环境检测结果
const uninstallCheckResult = ref({})

/**
 * 卸载
 * @param key
 */
const uninstallAddonFn = (key: string) => {
    preUninstallCheck(key).then(({ data }) => {
        if (data.is_pass) {
            uninstallAddon({ addon: key }).then(res => {
                localListFn()
                userStore.getAppList()
                loading.value = false
            }).catch(() => {
                loading.value = false
            })
        } else {
            uninstallCheckResult.value = data
            uninstallShowDialog.value = true
        }
    })
}

const market = () => {
    window.open('https://www.niucloud.com/product')
}

/**
 * 安装弹窗关闭提示
 * @param done
 */
const installShowDialogClose = (done: () => {}) => {
    if (installStep.value == 2) {
        ElMessageBox.confirm(
            t('installShowDialogCloseTips'),
            t('warning'),
            {
                confirmButtonText: t('confirm'),
                cancelButtonText: t('cancel'),
                type: 'warning'
            }
        ).then(() => {
            done()
        }).catch(() => { })
    } else done()
}

// 插件详情
const appStoreShowDialog = ref(false)
const appStoreInfo = ref<AnyObject>({})
const getAddonDetialFn = (data: AnyObject) => {
    appStoreShowDialog.value = true
    appStoreInfo.value = data
}

// 授权
const authCodeApproveDialog = ref(false)
const authinfo = ref('')
const getAuthCodeDialog = ref(null)
const saveLoading = ref(false)
const checkAppMange = () => {
    getAuthinfo()
        .then((res) => {
            if (res.data.data && res.data.data.length != 0) {
                authinfo.value = res.data.data
            }
        })
        .catch(() => {
            authCodeApproveDialog.value = false
        })
}
checkAppMange()
const authCodeApproveFn = () => {
    authCodeApproveDialog.value = true
}

const formData = reactive<Record<string, string>>({
    auth_code: '',
    auth_secret: ''
})
const formRef = ref<FormInstance>()

// 表单验证规则
const formRules = reactive<FormRules>({
    auth_code: [
        { required: true, message: t('authCodePlaceholder'), trigger: 'blur' }
    ],
    auth_secret: [
        { required: true, message: t('authSecretPlaceholder'), trigger: 'blur' }
    ]
})

const save = async (formEl: FormInstance | undefined) => {
    if (saveLoading.value || !formEl) return

    await formEl.validate(async (valid) => {
        if (valid) {
            saveLoading.value = true

            setAuthinfo(formData)
                .then(() => {
                    saveLoading.value = false
                    setTimeout(() => {
                       location.reload(); 
                    }, 1000);
                })
                .catch(() => {
                    saveLoading.value = false
                })
        }
    })
}

const goRouter = () => {
    window.open('https://www.niucloud.com/product')
}
</script>

<style lang="scss" scoped>
.demo-tabs>.el-tabs__content {
    padding: 32px;
    color: #6b778c;
    font-size: 32px;
    font-weight: 600;
}

.plug-item {
    .plug-item-operate {
        color: var(--el-color-primary);
        border-color: var(--el-color-primary);
        font-size: var(--el-font-size-extra-small);
    }
}

:deep(.t-container) {
    box-shadow: none !important;

    .t-window {
        padding: 10px 20px !important;
    }
}

.switch-btn.active {
    border-color: var(--el-color-primary);
    color: #fff;
    background-color: var(--el-color-primary);
}

.plug-large {
    .plug-item-operate {
        color: var(--el-color-primary);
        border-color: var(--el-color-primary);
        font-size: var(--el-font-size-extra-small);
    }
}

.app-text {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    -o-text-overflow: ellipsis;
}

// 插件安装-弹窗-表格样式
.table-head-bg {
    background: #f5f7f9;
}

html.dark .table-head-bg {
    background: #141414;
}

.el-alert .el-alert__title{
    font-size: 16px;
    line-height: 18px;
}
</style>
