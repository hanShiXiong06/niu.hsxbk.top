import{q as e,t,x as a,T as s,a2 as n,a3 as i,e as c,f as o,m as r,r as l,G as u,c as h,a4 as d,a5 as m,d as p,a as g,k as f,l as x,K as v,h as y,w as T,A as _,B as C,j as b,D as k,M as w,a6 as N,a0 as S}from"./index-5ccb7aca.js";import{_ as E}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as G}from"./u-input.7a3c5066.js";import{_ as $}from"./u-modal.276d8a5f.js";const K=E({name:"u-code",mixins:[t,a,{props:{seconds:{type:[String,Number],default:e.code.seconds},startText:{type:String,default:e.code.startText},changeText:{type:String,default:e.code.changeText},endText:{type:String,default:e.code.endText},keepRunning:{type:Boolean,default:e.code.keepRunning},uniqueKey:{type:String,default:e.code.uniqueKey}}}],data(){return{secNum:this.seconds,timer:null,canGetCode:!0}},mounted(){this.checkKeepRunning()},watch:{seconds:{immediate:!0,handler(e){this.secNum=e}}},methods:{checkKeepRunning(){let e=Number(s(this.uniqueKey+"_$uCountDownTimestamp"));if(!e)return this.changeEvent(this.startText);let t=Math.floor(+new Date/1e3);this.keepRunning&&e&&e>t?(this.secNum=e-t,n(this.uniqueKey+"_$uCountDownTimestamp"),this.start()):this.changeEvent(this.startText)},start(){this.timer&&(clearInterval(this.timer),this.timer=null),this.$emit("start"),this.canGetCode=!1,this.changeEvent(this.changeText.replace(/x|X/,this.secNum)),this.setTimeToStorage(),this.timer=setInterval((()=>{--this.secNum?this.changeEvent(this.changeText.replace(/x|X/,this.secNum)):(clearInterval(this.timer),this.timer=null,this.changeEvent(this.endText),this.secNum=this.seconds,this.$emit("end"),this.canGetCode=!0)}),1e3)},reset(){this.canGetCode=!0,clearInterval(this.timer),this.secNum=this.seconds,this.changeEvent(this.endText)},changeEvent(e){this.$emit("change",e)},setTimeToStorage(){if(this.keepRunning&&this.timer&&this.secNum>0&&this.secNum<=this.seconds){let e=Math.floor(+new Date/1e3);i({key:this.uniqueKey+"_$uCountDownTimestamp",data:e+Number(this.secNum)})}}},beforeDestroy(){this.setTimeToStorage(),clearTimeout(this.timer),this.timer=null}},[["render",function(e,t,a,s,n,i){const l=r;return c(),o(l,{class:"u-code"})}],["__scopeId","data-v-198ccd63"]]);function R(e){const t=l("");return{image:t,refresh:async()=>{try{const a=await m();e.captcha_key=a.data.captcha_key,e.captcha_code="",t.value=a.data.img.replace(/\r\n/g,"")}catch(a){}}}}const D=p({__name:"sms-code",props:{mobile:String,type:String,modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(e,{emit:t}){const a=e,s=h({get:()=>a.modelValue,set(e){t("update:modelValue",e)}}),n=l(null),i=function(e){const t=l(u("getSmsCode")),a="X"+u("smsCodeChangeText"),s=h((()=>!e.value||e.value.canGetCode));return{tips:t,seconds:90,canGetCode:s,send:async t=>{if(!s.value)return;e.value.start();let a=!1;return await d(t).then((t=>{1==t.code?a=t.data.key:(e.value.reset(),a=!1)})).catch((t=>{a=!1,e.value.reset()})),a},codeChange:e=>{t.value=e},changeText:a}}(n),o=l(!1),m=g({mobile:"",captcha_code:"",captcha_key:"",type:a.type}),p=R(m),E=async()=>{if(n.value.canGetCode){if(m.mobile=a.mobile,uni.$u.test.isEmpty(m.mobile))return void N({title:u("mobilePlaceholder"),icon:"none"});if(!uni.$u.test.mobile(m.mobile))return void N({title:u("mobileError"),icon:"none"});await p.refresh(),o.value=!0}},D=async()=>{if(uni.$u.test.isEmpty(m.captcha_code))return void N({title:u("captchaPlaceholder"),icon:"none"});const e=await i.send(m);e?(s.value=e,o.value=!1):!1===e&&p.refresh()};return(e,t)=>{const a=r,s=f(x("u-code"),K),l=f(x("u-input"),G),h=S,d=f(x("u-modal"),$);return c(),v(w,null,[y(a,{class:k({"text-primary":b(i).canGetCode.value,"text-gray-300":!b(i).canGetCode.value}),onClick:E},{default:T((()=>[_(C(b(i).tips.value),1)])),_:1},8,["class"]),y(s,{seconds:b(i).seconds,"change-text":b(i).changeText,ref_key:"smsRef",ref:n,onChange:b(i).codeChange},null,8,["seconds","change-text","onChange"]),y(d,{show:o.value,title:b(u)("captchaTitle"),"confirm-text":b(u)("confirm"),"cancel-text":b(u)("cancel"),"show-cancel-button":!0,onCancel:t[2]||(t[2]=e=>o.value=!1),onConfirm:D},{default:T((()=>[y(a,{class:"flex mt-[20rpx]"},{default:T((()=>[y(l,{placeholder:b(u)("captchaPlaceholder"),border:"surround",modelValue:m.captcha_code,"onUpdate:modelValue":t[0]||(t[0]=e=>m.captcha_code=e)},null,8,["placeholder","modelValue"]),y(h,{src:b(p).image.value,class:"h-[76rpx] ml-[20rpx]",mode:"heightFix",onClick:t[1]||(t[1]=e=>b(p).refresh())},null,8,["src"])])),_:1})])),_:1},8,["show","title","confirm-text","cancel-text"])],64)}}});export{D as _,R as u};
